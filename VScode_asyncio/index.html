<!DOCTYPE html>
<head>
  <style> 
  textarea {
    width: 100%;
    height: 150px;
    padding: 12px 20px;
    box-sizing: border-box;
    border: 2px solid #ccc;
    border-radius: 4px;
    background-color: #f8f8f8;
    font-size: 16px;
    resize: none;
  }
  .btn-group .button {
  background-color: #808080; 
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  cursor: pointer;
  float: left;
}

.btn-group .button:hover {
  background-color: #A9A9A9;
}
  </style>
  </head>
<meta charset="utf-8"/>
<title>WebSocket Test</title>
<!-- <script language="javascript" type="text/javascript"> -->
<meta http-equiv="Pragma" content="no-cache">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script> 

  // Client for Python SimpleWebsocketServer
  const portnum = 8001;
  var websock;
  var host, server, connected = false;
  xx=[];
  peak_x1 = [];
  peak_x2 = [];
  yy=[];
  zz =[];
  dyy = [];
  dzz = [];
  peak1 = [];
  peak2 = [];
  ptt =[];
  cnt = 0;
  j = 0;
  i = 0;


  // Display the given text
  function display(s)
  {
    document.myform.text.value += s;
    document.myform.text.scrollTop = document.myform.text.scrollHeight;
  }

  // Initialisation
  function init()
  {
    host = location.host ? String(location.host) : "unknown";
    host = host.replace("127.0.0.1", "localhost");
    server = host.replace(/:\d*\b/, ":" + portnum);
    document.myform.text.value = "Host " + host + "\n";
    // window.setInterval(timer_tick, 1000);
  }

  // Open a Websocket connection
  function connect()
  {
    var url = "ws://" + server + "/";
    display("Opening websocket " + url + "\n");
    websock = new WebSocket(url);
    // websock = new WebSocket("ws://localhost:8001/")
    websock.onopen    = function(evt) {sock_open(evt)};
    websock.onclose   = function(evt) {sock_close(evt)};
    websock.onerror   = function(evt) {sock_error(evt)};
    connected = true;
  }
  // Close a Websocket connection
  function disconnect()
  {
    websock.send('stop');
    connected = false;
    display("\ndisconnected\n");
    websock.close();
  }


  function start()
  {
    websock.send('start');
    // Plotly.newPlot('graph', [my_plot,my_plot1],layout);
    Plotly.newPlot('graph', data, layout);
    Plotly.newPlot('graph2', data2, layout2);
    Plotly.newPlot('graph3', data3, layout3);
    websock.onmessage = function(evt) {sock_message(evt)};
  }


  var trace1 = {
  x: [1, 2, 3],
  y: [40, 50, 60],
  name: 'Wrist Signal',
  type: 'scatter',
  yaxis: 'y' // This trace follows the left y-axis
};

var trace2 = {
  x: [2, 3, 4],
  y: [4, 5, 6],
  name: 'Elbow Signal',
  yaxis: 'y2',
  type: 'scatter'
};

var trace_p1 = {
  x: [1, 2, 3, 4],
  y: [10, 15, 13, 17],
  name: 'Wrist Signal Peak',
  yaxis: 'y',
  mode: 'markers'
};

var trace_p2 = {
  x: [1, 2, 3, 4],
  y: [10, 15, 13, 17],
  name: 'Elbow Signal Peak',
  yaxis: 'y2',
  mode: 'markers'
};

var ptt0 = {
  x: [1, 2, 3, 4],
  y: [10, 15, 13, 17],
  name: 'Elbow Signal Peak',
  yaxis: 'y2',
  mode: 'scatter'
};


var data = [trace1, trace2];
var data2 = [trace1, trace2, trace_p1, trace_p2];
var data3 = [ptt0];

var layout = {
  title: 'PTT Measurement',
  yaxis: {title: 'FBG1'},
  yaxis2: {
    title: 'FBG2',
    titlefont: {color: 'rgb(148, 103, 189)'},
    tickfont: {color: 'rgb(148, 103, 189)'},
    overlaying: 'y',
    side: 'right'
  }
};

var layout2 = {
  title: 'Second Derivative',
  yaxis: {title: 'FBG1'},
  yaxis2: {
    title: 'FBG2',
    titlefont: {color: 'rgb(148, 103, 189)'},
    tickfont: {color: 'rgb(148, 103, 189)'},
    overlaying: 'y',
    side: 'right',
  }
}

var layout3 = {
  title: 'PTT',
  yaxis: {title: 'PTT'}
}

  // Display incoming data
  function sock_message(evt) {
  // display(evt.data);
  
  data = JSON.parse(evt.data);
  const dictionary = data[9];
  const keyToCheck = 'p1';

  // Assuming data is an object with x and y values
  // Update the existing arrays with new data
  for (i = 0; i <data.length; i++){
  xx.push(data[i].x);
  yy.push(data[i].y1);
  zz.push(data[i].y2);
  dyy.push(data[i].dy1);
  dzz.push(data[i].dy2);
  }


if (dictionary.hasOwnProperty(keyToCheck)) {
  peak_x1.push(data[(data.length)-1].px1)
  peak_x2.push(data[(data.length)-1].px2)
  peak1.push(data[(data.length)-1].p1);
  peak2.push(data[(data.length)-1].p2);
  ptt.push(data[(data.length)-1].time);
}


  // Update the plot with the new data
  Plotly.update('graph', {x: [xx], y: [yy,zz],layout});
  Plotly.update('graph2', {x: [xx,xx,peak_x1, peak_x2], y: [dyy,dzz,peak1,peak2],layout2});
  Plotly.update('graph3', {x: [i+1], y: [ptt],layout3});
}

  // Handlers for other Websocket events
  function sock_open(evt)
  {
    display("Connected\n");
  }
  function sock_close(evt)
  {
    display("\nDisconnected\n");
  }
  function sock_error(evt)
  {
    display("Socket error\n");
    websock.close();
  }


  function download_wavelength(xx,yy,zz,dyy,dzz){
 // define the heading for each row of the data
 var csv = 'time,wavelength_shift_1,wavelength_shift_2,SecondDev_1,SecondDev_2\n';
 
    for (let i = 0; i < yy.length; i++) {
    csv += xx[i];
    csv += ",";
    csv += yy[i];
    csv += ",";
    csv += zz[i];
    csv += ",";
    csv += dyy[i];
    csv += ",";
    csv += dzz[i];
    csv+="\n";
    }
 

    var hiddenElement = document.createElement('a');  
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
    hiddenElement.target = '_blank'; 
    
    //provide the name for the CSV file to be downloaded  
    hiddenElement.download = 'wavelength_shift.csv';  
    hiddenElement.click();  

 }

 function download_PTT(peak_x1,peak1,peak_x2,peak2,ptt){
 // define the heading for each row of the data
 var csv = 'peak1_time,peak1,peak2_time,peak2,ptt\n';
 
    for (let i = 0; i < peak_x1.length; i++) {
    csv += peak_x1[i];
    csv += ",";
    csv += peak1[i];
    csv += ",";
    csv += peak_x2[i];
    csv += ",";
    csv += peak2[i];
    csv += ",";
    csv += ptt[i];
    csv+="\n";
    }
 

    var hiddenElement = document.createElement('a');  
    hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);  
    hiddenElement.target = '_blank'; 
    
    //provide the name for the CSV file to be downloaded  
    hiddenElement.download = 'PTT.csv';  
    hiddenElement.click();  

 }

  // Do initialisation when page is loaded
  window.addEventListener("load", init, false);

</script>
<form name="myform">
  <h2 style=" font-family: Arial;">WebSocket FBG Measurement</h2>
  <p>
  <textarea name="text" rows="10" cols="100">
  </textarea>
  </p>
  <p>
  <input type="button" value="Connect" onClick="connect();">
  <input type="button" value="Disconnect" onClick="disconnect();">
  <input type="button" value="Start" onClick="start();">
  <button class="delayed" onclick="download_wavelength(xx,yy,zz,dyy,dzz)"> Download FBG Signals </button>
  <button class="delayed" onclick="download_PTT(peak_x1,peak1,peak_x2,peak2,ptt)"> Download PTT Signals </button>
  </p>
</form>
<div id="graph" style=></div>
<div id="graph2" style=></div>
<div id="graph3" style=></div>
</html> 